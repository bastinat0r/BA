
\section{Robustness of Implementation}

For use in the FINken robots not only the quality of the measurements is relevant.
The sensor also needs to be well integrated into the autopilot framework.

With the current hardware this integration can not be done completly, because the current hardware plattform is simply to big to fly.
This step of integration will be done with the \todo{de-modules}.

\subsection{Bus hangup}
I2C is an easy to implement and use bus protocol.
One of the drawbacks of I2C is that misbehaving clients are able to block the whole bus.
As a consequence a malfunctioning sensor might render the others sensors useless, in worst case crashing the copter.

At the moment the ranging sensors cause bus hangups, when rangings are requested to often.
\todo{measure}

\subsection{i2c errors per time}
Another problem that may occure is that i2c data packets can get lost.
This would mean the autopilot has to rely on expired data and it might break any kind of derivate computed from the range value. \todo{jaja, als ob man da was sinvolles ausrechnen könnte :(}.
\todo{measure}

\subsection{Integration Test for Quadcopter}


\section{Ranging Accuracy}

The most important question for the FINken project is: \enquote{Can the ranging values be used by the FINken robots}.
To answer this question some understanding of the magnitude and distribution of the ranging error is needed.

Finding out how accurate the range values actually are proves rather diffucult, because there are lots of interdependend variables that influence ranging accuracy.

\subsection{Frequency Selection}
\label{freqencyselection}
\todo{move to implementation?}
The frequencys used by the ranging can be chosen by the user of the ranging nodes,
however frequency selection greatly influences the quality of the measurements.
This is especially because normal \SI{2.4}{\giga\hertz} wifi and serveral other technologies are using the same frequencys as the ranging modules the selection of a well working one is crucial to ranging performance.
In \autoref{spectrum2437} there is an analysis on the frequency utilization on wifi channel 6.
A download was started and then ended which is noticable in the waterfall plot.

Comparing the utilization on this channel with the frequency range shown in \autoref{spectrum2483} which is right next to the first frequency used by the ranging modules several things can be noticed.
The noise in the frequency range for ranging is much lower then on frequencys with used for wifi—about \SI{15}{dB} in average and \SI{20}{dB} in peak.
You can also see the peak generated by the ranging modules.
The line at the center frequency \SI{2.4831}{\giga\hertz} is an artifact created by the SDR that was used, but the line at \SI{2.483}{\giga\hertz} is created by the ranging modules (which is exactly why the center frequency was chosen right next to the actual frequency).
You can already see that the peak can still be lost in noise like it is shown in the FFT plot but is very stable over time as you can see in the waterfall plot.

Because of the lower utilization of those frequencys a range of \SI{2.480}{\giga\hertz} to \SI{2.500}{\giga\hertz} has been chosen.
All the frequencys in this range look quite simmilar to the sample taken at \autoref{spectrum2483}.
This values have to be taken with a grain of salt.
It is really hard to reproduce what kind of RF-noise interfering with the nodes is currently generated in the swarmlab.

There are other factors that impact ranging quality that can not be measured that easily – at least the quality of the antennas for different frequencies and the impact of the number of aviable channels in the frequency range and channel spacing are variables that can not be directly measured in our lab\footnote{The sourcecode and algorithms used by the modules is closed source, so we are not able to infere the effect of channel spacing and number of channels from that.}. 
\todo{Find out antanna measurements / calibrated antennas}
In the end this means finding the right parameters for ranging frequency settings is a really hard problem, especially because measuring the ranging error over many frequencys takes lots of labtime. \todo{wording}
It is not viable to measure all aviable combinations for those parameters.
\todo{labtime + lab utilization ... ? or is this to mimimi}


\begin{figure}[H]
	\centering
\includegraphics[width=0.9\textwidth]{figures/ch6.png}
\label{spectrum2437}
\caption{RF-Spectrum on \SI{2.437}{\giga\hertz}}
\end{figure}

\begin{figure}[H]
	\centering
\includegraphics[width=0.9\textwidth]{figures/ranging_0.png}
\label{spectrum2483}
\caption{RF-Spectrum on \SI{2.483}{\giga\hertz}}
\end{figure}


Even with those frequencies the measurement is only really working when the lab is empty, as basically every person in the lab uses several devices that use the \SI{2.4}{GHz} frequency range.
To create a usefull evaluation all the following measurements have been made with an empty lab out of the working hours of the people in the buliding.
However this problem must be addressed before the sensors can be used in a real world application.
This is especially true because the remote control is causing the worst interference with the ranging nodes observed so far.

There are two possible solutions to the general problem: Either the noise in the environment needs to be reduced or the ranging nodes need to use different frequencies.


\subsection{Measurement Setup}

All the following evaluation is done by analysing data gathered by the ranging nodes.
However the measurements are done in a very specific manner to improve the quality of the measured data.
\begin{itemize}
	\item the nodes are lifted from the table to minimize multipath effects
	\item a stable 3.3V input voltage is provided by different voltage regulators, the battery slots are not used
	\item antennas are always used in the same orientation
	\item measurements are not taken in the working hours of the faculty (mostly deep at night) when the least ammount of RF interference by \SI{2.4}{GHz} devices can be expected
\end{itemize}

\begin{figure}[H]
	\centering
	\includegraphics[width=0.9\textwidth]{figures/messaufbau.png}
	\caption{Measurement Setup}
	\label{aufbau}
\end{figure}


\subsection{Influence of DQF on Range Values}
One value the ranging api provides is the DQF\footnote{Data Quality Factor}-value.
It is reasonable to expect a huge amount of scatter for lower DQF values.
As \autoref{1m_scatterplot} shows this is not how the range value behaves.

For the values measured with \SI{1}{\metre} real distance we can see that the values measered with lower quality do not have the same mean value as those with higher quality.
Also values measured with lower quality are closer to each other than those with higher signal quality.
As long as we only look at the values taken at \SI{1}{\metre} real distance it seams like we could be able to improve the range estimate by including the dqf value into the computation of the distance.
To do that this behaviour would need to be stable accross different distances, i.e. no matter if the measurement is taken at \SI{1}{\metre} or \SI{3}{\metre} distance the when the dqf is low the measured range is lower and if dqf is high the measured range is higher.
\begin{figure}[H]
	\centering
	\input{figures/scatterplot_1000_1m.pgf}
	\caption{1000 values measured at \SI{1}{\metre} distance}
	\label{1m_scatterplot}
\end{figure}

\autoref{range_05_to_2m} shows measurements taken at different distances.
The values for further distances have far more noise than values for lower distances.
This leads to bad consequences.
\begin{figure}[H]
	\centering
	\input{figures/range_05_to_2m.pgf}
	\caption{values measured at \SI{0.5}{\metre} to \SI{2}{\metre} real distance}
	\label{range_05_to_2m}
\end{figure}

\begin{figure}[H]
	\centering
	\input{figures/2m.pgf}
	\caption{100 values measured at \SI{2}{\metre} distance}
	\label{2m}
\end{figure}

%\subsection{Influence of Input Voltage}
%
%The input voltage has a huge impact on the quality of range values.
%This especially means that the battery compartment of the ranging modules must not be used.
%\todo{messreihe}

\subsection{Influence of Distance}

It is important to know how the ranging nodes behave at different distances.
In \autoref{boxplot} this relationship is shown.
The results are not what was hoped for when the hardware was selected.
As you can see in \autoref{boxplot} the lower values yielded for any given distance might be in the intervall yielded for pretty much all distances.
Additionaly the mean values are not even nearly monotone, there are some irregularities in the values where a higher distance leads to lower range values.
\todo{prettify}
\begin{landscape}
	\begin{figure}[h]
		\centering
		\input{figures/boxplot.pgf}
		\caption{range values and real distance}
		\label{boxplot}
	\end{figure}

	\begin{figure}[h]
		\centering
		\input{figures/nightshift_all.pgf}
		\caption{Range values with \SI{2}{\centi\metre} resolution}
		\label{resoulution}
	\end{figure}

	\begin{figure}[h]
		\centering
		\input{figures/buckets.pgf}
		\caption{Range values with \SI{1}{\centi\metre} resolution each bar represents all the values in the range, with bucket size of \SI{20}{\centi\metre}}
		\label{buckets}
	\end{figure}
\end{landscape}
\todo{caption for buckets (wording)}

Looking at a smaller resolution of distance values you can see exactly the same thing.
This seems very bad at first glance.
However the values look much better when multiple readings are combined.
The result of this approach is shown in \autoref{buckets}.

However we can not simply measure 20 values to compute a filtered value at once, especially as the values must not be measured at the same distance.
As long as the quadcopter is moving measurements could be taken continuously.

\subsection{Antenna Orientation}
\todo{ (diversity, no diversity) * (parallel, perpendicular) }



\subsection{Orientation of Devices}


\subsection{Moving Nodes}
Movement has an influence on the quality of the range values depending on the ranging method used.
For the phase different measurements a moving node could mess up the range value if the phase differces measured at multiple frequencys don't match the same distance because the node moved in between. \todo{wording}

However moving the node in a defined way and taking a measurement at a fixed distance is a sophisticated task.

\subsection{Ranging on FINken Robots}

\section{Properties of a Distance Function}
The ranging sensor on the FINken robot shall be used to provide a distance between two quadcopters, similar to a distance measure used in swarm intelligence algorithms.
In the pure mathematical sense a distance function has to fullfill certian properties.

If $f(x, y)$ is a distance function it has to have the following properties.
\begin{eqnarray}
f(x, y) \ge 0 \\
f(x, y) = 0 \iff x = y \\ 
f(x, y) = f(y, x) \\ 
f(x, z) \le f(x, y) + f(y, z)
\end{eqnarray}

Of course the value measured by any real sensor will not completly accomplish to satisfy those conditions.
For use in swarm robotics it is therefore very interesting to know in which way the range values break the pattern of a mathematical distance function.

\subsection{Non-negativity and Coincidence}

The first property of a mathematical distance measure to look at is non-negativity. This is quite easy: The values yielded by the ranging modules are clearly positiv.
Also the property of coincidence is always given.
Each module has a unique address and is therefore able to check, if it is ranging itself.
Having two modules occupy the same physical spot is obviosly not possible so there cannot be two different modules that are equvivalent in a mathematical sense.

\subsection{Symmetry}

In this section the following notation will be used: $A \rightarrow B$ means a range reading is taken from node A with B as reflector node.

Symmetry is a property that can not be achieved by the ranging sensors because of noise. 
A range reading $A \rightarrow B$ will not be equal to the reading for $B \rightarrow A$ just because the two readings will be altered by noise.
The question that remains is: Do we have the same error for both directions.

\todo{plot, evaluate, spoiler alert: Nope!}


However the lack of symmetry might be utilized.
\begin{equation}
\frac{ d(A \rightarrow B) + d(B \rightarrow A) }{2}
\label{symavg}
\end{equation}
The remote ranging ability of the nodes can be exploited to gather both values $A \rightarrow B$ and $B \rightarrow A$ by averaging those values the error might be lowered. \todo{data}
The new value shown in \autoref{symavg} will be symmetric.

\subsection{Triangle Inequality}
The triangle inequality will also be broken by noise.
I.e. if we measure $d(A,B) + X + d(B,C) + X$ and $d(A, C) + X$ the measurement error $X$ might as well break the condition of the Triangle Inequality.

\begin{figure}[H]
	\centering
	\input{figures/triangle.pgf}
	\caption[Density functions for 3 nodes]{Density functions for 3 nodes, Nodes were placed in a straight line with numbers 1, 2, 3. Distance 1-2 was \SI{150}{cm}, distance 2-3 was \SI{50}{cm}. }
	\label{triangle}
\end{figure}


\section{Conclusion}

Let's take a look at the requirements from \autoref{req}.\todo{-> unpersonal lingo}
It is possible to integrate the sensor nodes into the FINken robots, however not in the current hardware setup.
The interference of copters and sensors is not as easy as was thought.
RF-Interference disturbes the function of our distance sensor.
At least the functionality of the copters does not seem to be disrupted by the ranging nodes.
It is still possible to solve this problem by changing the hardware on the copter or the frequency the ranging nodes operate at.

In the end the quality of the range measurements is deciding\todo{wording?} if the requirements are met.
The measured range values are not as good as was hoped for.
A filter needs to be implemented to compute a usable range estimate should be given.
This would introduce a time delay into the measurement which is not desireable. \todo{wording}

If the right method for filtering is applied the sensor nodes can still be usefull for the FINken robots.
