
As stated in \autoref{req} the sensors shall be integrated into the FINken robot in a way that is does not disrupt the normal operation of the FINken robots.
In order to do so a version\todo{wording} of the hardware has to be chosen that is not to big and heavy for a flying robot.
Additionally an interface to the autopilot board has to be found that integrates well into the existing infrastructure.

\section{Hardware}

\subsection{Ranging Hardware}
\label{ranginghardware}

There are several different possible hardware plattforms for the Atmel ranging software.
At the time this thesis started using the firmware of the Atmel Ranging Toolbox~\cite{atmelrtb} for the REB233SMAD Evaluation Kit~\cite{REB233SMAD} was the only setup that was already supporting ranging.

For evaluation those modules are quite useable, but there are better options available for use in the real application, as the sensors from the evaluatio kit are quite big and heavy.
It is planned to use 802.15.4 modules from dresden elektronik which are already integrated into the new hardware revision of the FINken robots as telemetrie transmitter.
\todo{other frequency}
Another way to integrate this approach to ranging into the FINken robots is to miniaturize the REB233SMAD-modules, by leaving unused PCB-area and connectors.
This can be done by using the ATZB-X0-256-3-0-C ZigBit~\cite{atmelzigbit} modules, that use the same radio module and processor as the REB233SMAD-kits.

In conclusion the dresden elektronik modules are best suited for the copters.
If it would become apparent that those modules are not capable of ranging it would still be possible to create a miniaturized version of the Atmel sensors.
As seen in \autoref{freqencyselection} using another frequency might cause a big improvement in ranging quality.
This is especially if the modules can be used for ranging and telemetry at the same time.

\subsection{Assembly}

As it is unclear which version of the ranging hardware is best for the FINken robots there are several ways to fasten the ranging modules.

If a module from dresden elektronik is used it can simply be plugged into the header currently used for the telemerie module.
If a new PCB is used it can be mounted using the fixed hole spacing of \SI{30.5}{mm} that is used by a lot of quatcopter hardware components.

Maybe an extra mounting method is needed for the antenna.
The best place for the antenna is probably on top of the sensor tower to lower interference with the other components of the copter.

\section{Software Architecture}
The FINken robots are controlled by a micro controller handling all the computation needed.
There is no distinction between higher level logic like pathplanning and and low level code as the stabilization of the copter in terms of hardware.
The exact board that is used is the LISA/MX autopilot board in hardware revision 2.1~\cite{lisamx} wich runs the paparazzi autopilot firmware\cite{paparazzi}.
The paparazzi framework provides an easy way to implement new hardware drivers for alle devices that are connected to the board via several possible interfaces.

\begin{figure}[H]
	\centering	
	\tikzset{every shadow/.style={fill=none,shadow scale=0}}
	\smartdiagramset{
		module shape=rectangle,
		%border color=none,
		uniform arrow color=true,
		arrow color=gray,
		back arrow disabled=true,
		set color list={orange, green, green, green, yellow, yellow, yellow}
	}
	\smartdiagram[flow diagram:horizontal]
	{Sensors, Sensor Module, Navigation, Stabilization, Motor Control}
	\label{flow}
	\caption[ Information Flow in the FINken Robots ]
	{Information Flow in the FINken Robots. 
	All software components of the the autopilot board are shown in green.
	Sensor hardware is shown in orange and actuator hardware is shown in yellow.}
\end{figure}

 

An important design desicion is how to devide the process of ranging and filtering the results between autopilot and sensor node.
The sensor could yield it's raw values to the master device and be done.
This allows to implement fine tuned and application specific filtering, however it also means that there is no convenient way of getting reasonable values that are already filtred.
Another factor that influences this decision is the processing power of the sensor nodes.
Running filters on the sensor node might free up valuable processing power and memory in the master device.

As the FINken robots autopilot is quite well resourced and the measurements are probably not good enough to be used without sophisticated filtering only the raw values of the sensors are used.

However it might still be a good idea to provide higher level data computed by the sensor nodes later on.
Position estimation is an application that needs a lot of computation and memory.
Additionally computing postition estimates will be similiar accross different applications of the ranging modules.
The position estimate might also be used as a direct input to filters that use additional information directly, especially if the computation of the position does not cause a delay in the sensor data.


\section{Interconnect}
All components of the FINken communicate directly with the autopilot board as can be seen in \autoref{bubble}.
The new sensor shall be connected to the autopilot as well.

Different methods can be used to achieve this.
In \autoref{hwconnection} all the interfaces supported by the LISA/MX board and the connected devices are listed.
One of those interfaces will be used for the new sensor.

\begin{figure}[h]
	\centering	
	\smartdiagramset{
		distance planet-satellite=4.5cm,
		planet color=green,
		planet size=4cm,
		satellite size=2.5cm,
		uniform connection color=true,
		set color list={yellow, orange, orange, orange, magenta, magenta, orange, orange},
		/tikz/connection planet satellite/.append style={<->}
	}
	\smartdiagram[constellation diagram]
	{Autopilot, Motors, Sonsar\\Sensors, IR-Sensor, Color\\Sensor, Telemetry\\Module, RC-Reciever, Optical Flow\\Sensor, Ranging\\Sensor}	
	\label{bubble}
	\caption[Onboard Communication of the FINken Quadcopters]
	{Onboard Communication of the FINken Quadcopters. All sensor and actuator hardware is directly communicating with the autopilot board.
		\\
		Sensors are shown in organge, actuators are yellow and radio links are shown in magenta.
	}
\end{figure}

\begin{table}[h]
	\centering
	\begin{tabular}{|r|r | l | l|}
		\hline
		Available  & Used & Type       & Conneceted Hardware \\ \hline \hline
		4          &   2  & Analog Pin & IR-Sensor \\
		           &      &            & Battery Voltage \\ \hline
		4          &   3  & UART       & Telemetry \\
		           &      &            & RC-Reciever\\
		           &      &            & Optical Flow Sensor\\ \hline
		8          &   4  & PWM Output & 4 Motorcontrollers\\ \hline
		2          &   1  & I2C        & Ultrasound Sensors\\ \hline
		           &      &            & Color Sensor\\ \hline
		1          &   0  & CAN        & — \\ \hline
	\end{tabular}
	\caption{FINken 3—Hardware Ports and Usage}
	\label{hwconnection}
\end{table}

\subsection{Pulse width modulation / Analog value}
Using a single GPIO pin or analog value is completely impractical, but a good example to explain the problems the honest solutions need to address.

First of all there is a limited number of GPIO or ADC-pins on both boards.
On the autopilot board those pins are quite rare, especially because they cannot be shared easily between components.
The second problem is that we do not only need to read a range value from the sensor but we also need to tell the sensor which value to fetch.
Therefore some kind of bidirectional communication between autopilot and sensor need to take place.
The big advantage of using a GPIO pin would be that only one single wire\footnote{Two additional wires are needed to supply the sensor with power, those wires will be needed regardless of the communication protocol.} would be needed to connect autopilot and sensor.

\subsection{UART}
The "Universal Asynchronous Receiver/Transmitter"-Protocol uses two wires to establish communication between devices.
\cite{wingen_automatic_2004}

The disadvantage of the UART protocol is that it is a strictly point-to-point connection.
It is not possible to connect multiple slave devices to one UART port of the master device.
On the Lisa/MX autopilot there are four dedicated UART connections that might be used, but already three of them are used.

Additionally UART is a character based communication protocol.
As there is no detection for bit errors and no framing sophisticated protocoll design would be a neccesity for implementation.

%Using the last of those ports is not feasible as there are other better options available.

\subsection{SPI}
Serial Peripheral Interface is a four wired bus that also allows bidirectional communications.
There are two modes of operation that can be used in SPI.
In the independent slave configuration a single IO-pin defines which of the slaves is currently active.
As the LisaMX only has one chip select pin this mode is not really interesting to be used by the sensor nodes.


The daisy-chain-configuration uses the chip select pin to pass all data along the modules and works much like a shift register.
The other applications planned for the SPI port are communication with a high level processor and fast data logging to a micro SD-card that will need a lot of bandwith.
This means the sensor would need to be capable of high clock speeds and data rates in order to keep the bandwith for the other applications up\todo{wording}.
\todo{fact-check}


\subsection{CAN bus}
Controller Area Network is a bus protocol mainly known for its applications in the automotive area\todo{wording}.
CAN is an option available on the paparazzi board, however implementation on the sensor side would mean a lot of effort compared to the other communication protocols.

Additional hardware would be needed as well.
\todo{more, fact-check}

\subsection{I2C}

I2C is a two wired bus protocol that can be used to connect multiple slave devices to one master device.
As every communication in I2C is directed to the devices via an address it is quite simple to connect new devices in a star configuration simply by attaching it to the two wires of the bus.
There already are multiple sensors connected to the autopilot via I2C.
All of the ultrasound-sensors and also the optional color sensor use I2C to communicate with the autopilot.
This also means that there is already know how and code that can be utilized to connect the new sensors.

One of the disadvantages of I2C is that misbehaving slave devices can disrupt the communication of all devices on the bus.
The autopilot board supports to have two independent I2C-networks which makes it possible to separate critical and non-critical devices which helps to mitigate this problem.

Especially the fact that there already is a sensor network on the FINken makes I2C the best choice as a communication protocol for the new sensor.

\subsection{Findings}

It is possible to integrate the ranging nodes into the FINken robot.
I2C is the protocoll best suited for communication with the autopilot.

For an application in the robots a miniaturized version of the module is needed.
